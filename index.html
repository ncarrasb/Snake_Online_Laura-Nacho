<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SNAKE ONLINE - Cliente</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      margin: 20px;
      background-color: #f6f6f6;
    }

    h1 {
      font-size: 2.2rem;
      font-weight: 900;
      color: #145a32;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      margin-bottom: 10px;
    }

    #panel {
      display: flex;
      gap: 20px;
      align-items: flex-start;
      width: 500px;
      justify-content: space-between;
    }

    #bloqueConectar {
      display: flex;
      gap: 5px;
      align-items: center;
    }

    #textoServer {
      width: 260px;
      padding: 4px 6px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    #botonConectar {
      padding: 5px 10px;
      border: none;
      border-radius: 4px;
      background-color: #145a32;
      color: white;
      cursor: pointer;
      font-weight: bold;
    }

    #botonConectar:hover {
      background-color: #458b63;
    }

    #estado {
      font-size: 0.9rem;
      color: #555;
    }

    #juego {
      position: relative;
      width: 500px;
      height: 500px;
      border: 3px solid #8b4513;
      background-color: #f4e4c1;
      border-radius: 6px;
      overflow: hidden;
    }

    .jugador {
      position: absolute;
      width: 20px;
      height: 20px;
      background: #32cd32;
      border-radius: 4px;
    }

    .yo {
      background: #00ff66;
      box-shadow: 0 0 6px #00ff66;
    }

    #fruta {
      position: absolute;
      width: 20px;
      height: 20px;
      background: #e74c3c;
      border-radius: 50%;
      display: none;
      box-shadow: 0 0 4px #e74c3c;
    }

    #puntuaciones {
      min-width: 180px;
      font-size: 0.9rem;
      color: #145a32;
      font-weight: bold;
      margin-top: 5px;
      position: relative;
      left: 35px;
    }

    #puntuaciones h3 {
      margin: 0 0 4px 0;
      font-size: 1rem;
      text-decoration: underline;
      color: #145a32;
    }

    .puntuacion-item {
      margin: 2px 0;
    }
  </style>
</head>

<body>
  <h1>SNAKE ONLINE</h1>

  <div id="panel">
    <div id="bloqueConectar">
      <!-- ðŸ‘‡ Cambiado: URL por defecto de Render -->
      <input id="textoServer" value="https://snake-online-laura-nacho.onrender.com/" />
      <button id="botonConectar">Conectar</button>
    </div>
    <div id="estado">Desconectado</div>
  </div>

  <div id="juego">
    <div id="fruta"></div>
  </div>

  <div id="puntuaciones">
    <h3>Puntuaciones</h3>
    <div id="listaPuntos"></div>
  </div>

  <script>
    const SIZE = 500;
    const CELL = 20;
    const MAX = SIZE - CELL;

    let socket = null;
    let miId = null;
    let miDireccion = "0";
    const jugadores = {};
    let fruta = null;

    const contenedor = document.getElementById("juego");
    const frutaDiv = document.getElementById("fruta");
    const listaPuntos = document.getElementById("listaPuntos");
    const botonConectar = document.getElementById("botonConectar");
    const textoServer = document.getElementById("textoServer");
    const estado = document.getElementById("estado");

    botonConectar.addEventListener("click", () => {
      let url = textoServer.value.trim();
      if (!url) return;

      // âš™ï¸ Normaliza: si estÃ¡s en HTTPS, fuerza WSS
      if (location.protocol === "https:" && url.startsWith("ws://")) {
        url = "wss://" + url.slice(5);
      }

      if (socket) socket.close();

      limpiarEscena();
      estado.textContent = "Conectando...";
      socket = new WebSocket(url);

      socket.addEventListener("open", () => {
        estado.textContent = "Conectado. Esperando jugadores...";
        miId = null;
      });

      socket.addEventListener("close", () => {
        estado.textContent = "Desconectado";
        miId = null;
        limpiarEscena();
      });

      socket.addEventListener("error", () => {
        estado.textContent = "Error en la conexiÃ³n";
      });

      socket.addEventListener("message", (event) => {
        const m = parsearMensaje(event.data);
        if (!m || typeof m.tipo !== "string") return;
        manejarMensaje(m);
      });
    });

    function parsearMensaje(raw) {
      try { return JSON.parse(raw); } catch { return null; }
    }

    function manejarMensaje(m) {
      const datos = m.datos;
      switch (m.tipo) {
        case "new":
          if (!datos) return;
          if (miId === null) {
            miId = datos.id;
            estado.textContent = "Conectado. Tu ID: " + miId;
          }
          crearOActualizarJugador(datos);
          break;
        case "mover":
          if (!datos) return;
          const id = datos.id;
          if (!jugadores[id]) {
            jugadores[id] = { x: 0, y: 0, dir: "0", puntos: 0 };
            crearDivJugador(id);
          }
          jugadores[id].x = datos.x;
          jugadores[id].y = datos.y;
          jugadores[id].dir = datos.dri || datos.dir || "0";
          dibujarJugador(id);
          break;
        case "score":
          if (!datos) return;
          const { id: idScore, puntos } = datos;
          if (!jugadores[idScore]) {
            jugadores[idScore] = { x: 0, y: 0, dir: "0", puntos: 0 };
            crearDivJugador(idScore);
          }
          jugadores[idScore].puntos = puntos || 0;
          actualizarPuntuaciones();
          break;
        case "fruit":
          if (!datos) return;
          fruta = { x: datos.x, y: datos.y };
          dibujarFruta();
          break;
        case "delete":
          eliminarJugador(datos);
          break;
      }
    }

    function crearDivJugador(id) {
      let div = document.getElementById("jugador-" + id);
      if (!div) {
        div = document.createElement("div");
        div.id = "jugador-" + id;
        div.className = "jugador";
        contenedor.appendChild(div);
      }
      if (String(id) === String(miId)) {
        div.classList.add("yo");
      }
      return div;
    }

    function crearOActualizarJugador(info) {
      const { id, x, y, dir, puntos } = info;
      if (!jugadores[id]) {
        jugadores[id] = { x: x, y: y, dir: dir, puntos: puntos || 0 };
        crearDivJugador(id);
      } else {
        jugadores[id].x = x;
        jugadores[id].y = y;
        jugadores[id].dir = dir;
        jugadores[id].puntos = puntos || jugadores[id].puntos;
      }
      dibujarJugador(id);
      actualizarPuntuaciones();
    }

    function dibujarJugador(id) {
      const j = jugadores[id];
      const div = document.getElementById("jugador-" + id);
      if (!j || !div) return;
      div.style.left = j.x + "px";
      div.style.top = j.y + "px";
    }

    function eliminarJugador(id) {
      delete jugadores[id];
      const div = document.getElementById("jugador-" + id);
      if (div) div.remove();
      actualizarPuntuaciones();
    }

    function limpiarEscena() {
      for (const id in jugadores) eliminarJugador(id);
      fruta = null;
      frutaDiv.style.display = "none";
      listaPuntos.innerHTML = "";
    }

    function dibujarFruta() {
      if (!fruta) return;
      frutaDiv.style.left = fruta.x + "px";
      frutaDiv.style.top = fruta.y + "px";
      frutaDiv.style.display = "block";
    }

    function actualizarPuntuaciones() {
      listaPuntos.innerHTML = "";
      const arr = Object.entries(jugadores).map(([id, j]) => ({ id, puntos: j.puntos || 0 }));
      arr.sort((a, b) => b.puntos - a.puntos);
      for (const j of arr) {
        const div = document.createElement("div");
        div.className = "puntuacion-item";
        div.textContent = `Jugador ${j.id}: ${j.puntos}`;
        if (String(j.id) === String(miId)) div.style.fontWeight = "bold";
        listaPuntos.appendChild(div);
      }
    }

    document.addEventListener("keydown", (ev) => {
      if (!socket || socket.readyState !== WebSocket.OPEN || miId === null) return;
      const k = ev.key.toLowerCase();
      let nueva = miDireccion;
      if (["w","a","s","d"].includes(k)) nueva = k;
      if (nueva !== miDireccion) {
        miDireccion = nueva;
        const me = jugadores[miId];
        if (me) { me.dir = miDireccion; enviarMover(); }
      }
    });

    document.addEventListener("keyup", (ev) => {
      if (!socket || socket.readyState !== WebSocket.OPEN || miId === null) return;
      const k = ev.key.toLowerCase();
      if (["w","a","s","d"].includes(k)) {
        miDireccion = "0";
        const me = jugadores[miId];
        if (me) { me.dir = miDireccion; enviarMover(); }
      }
    });

    function enviarMover() {
      const me = jugadores[miId];
      if (!me) return;
      const msg = { tipo: "mover", datos: { dir: miDireccion, x: me.x, y: me.y } };
      socket.send(JSON.stringify(msg));
    }

    function enviarComer(x, y) {
      const msg = { tipo: "comer", datos: { x, y } };
      socket.send(JSON.stringify(msg));
    }

    setInterval(() => {
      if (!socket || socket.readyState !== WebSocket.OPEN) return;
      for (const id in jugadores) {
        const j = jugadores[id];
        if (j.dir === "a") j.x -= CELL;
        else if (j.dir === "d") j.x += CELL;
        else if (j.dir === "w") j.y -= CELL;
        else if (j.dir === "s") j.y += CELL;
        j.x = Math.max(0, Math.min(MAX, j.x));
        j.y = Math.max(0, Math.min(MAX, j.y));
        dibujarJugador(id);
      }
      if (miId && jugadores[miId]) {
        const me = jugadores[miId];
        enviarMover();
        if (fruta && me.x === fruta.x && me.y === fruta.y) {
          enviarComer(me.x, me.y);
        }
      }
    }, 120);
  </script>
</body>
</html>
